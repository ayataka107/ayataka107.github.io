<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>クリックで開閉・1行固定・自動フィット・保存あり（localStorage）</title>
<style>
  :root{
    --gap:14px; --radius:14px; --bg:#f7f7f8; --line:#e6e6ee;
    --rowH:48px; --rowPadV:10px; --rowPadH:12px;
    --minFontPx:12; --baseFontPx:16;
  }
  *{box-sizing:border-box}
  body{margin:20px;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:#222}
  h1{font-size:1.1rem;margin:0 0 12px}
  .wrap{display:grid;gap:18px;max-width:1200px}
  textarea,input,button,select{font-size:16px}
  textarea{width:100%;min-height:180px;padding:12px;border:1px solid #d5d7df;border-radius:var(--radius);background:#fff}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  input[type="text"], select{padding:10px 12px;border:1px solid #d5d7df;border-radius:12px;background:#fff}
  button{padding:6px 10px;border-radius:999px;border:1px solid #cfd2da;background:#fff;cursor:pointer;font-weight:600}
  button.primary{background:#111;color:#fff;border-color:#111}
  .grid{display:grid;gap:var(--gap);grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));}
  .col{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:14px;min-height:220px;box-shadow:0 2px 10px rgba(0,0,0,.04);}
  .titleRow{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .title{font-weight:800}
  ol{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
  li{position:relative;border:1px dashed #e9e9f1;border-radius:10px;background:#fafafa;overflow:hidden;cursor:pointer;height:var(--rowH);}
  .rowin{position:relative;z-index:1;display:flex;align-items:center;gap:10px;padding:var(--rowPadV) var(--rowPadH);height:100%;}
  .num{font-weight:800;min-width:3.2em;text-align:right;flex:0 0 auto;}
  .val{flex:1 1 auto;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
  .mask{position:absolute;inset:0;background:linear-gradient(180deg,#1f2329,#30363d);z-index:2;}
  .rankBadge{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:3;pointer-events:none;}
  .rankBadge .badge{background:#fff;color:#111;border:2px solid #111;border-radius:999px;padding:6px 12px;font-weight:800;box-shadow:0 2px 6px rgba(0,0,0,.15);}
  li.revealed .mask{display:none}
  li.revealed .rankBadge{display:none}
  .panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;gap:10px;}
  .panel h2{font-size:1rem;margin:0 0 4px}
  .panel .row{align-items:center}
  .panel .row > *{flex:1}
  .panel .row .narrow{flex:0 0 160px}
  .panel .row .mid{flex:0 0 220px}
</style>
</head>
<body>
  <h1>ランキング発表くん</h1>
  <div class="wrap">
    <textarea id="rank" placeholder="ランキングを1位から10位まで改行で入力" autocomplete="off"></textarea>
    <div class="row">
      <input id="title" type="text" placeholder="ランキングタイトル" autocomplete="off" class="mid">
      <button id="add" class="primary narrow">列を作る</button>
    </div>
    <div class="panel">
      <h2>編集パネル</h2>
      <div class="row">
        <select id="colSelect" class="mid"><option value="">列を選択</option></select>
        <select id="rankSelect" class="narrow"><option value="">順位</option></select>
        <input id="editInput" type="text" placeholder="内容を編集して保存" autocomplete="off">
        <button id="saveEdit" class="primary narrow">保存</button>
      </div>
    </div>
    <div id="grid" class="grid"></div>
  </div>

<script>
let colCounter = 0;
const STORAGE_KEY = 'rankingData.v1';

const elRank = document.getElementById('rank');
const elTitle = document.getElementById('title');
const elGrid  = document.getElementById('grid');
const colSelect  = document.getElementById('colSelect');
const rankSelect = document.getElementById('rankSelect');
const editInput  = document.getElementById('editInput');
const saveEdit   = document.getElementById('saveEdit');

/* 順位セレクト */
(function initRankSelect(){
  for (let i=1;i<=10;i++){
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = i + '位';
    rankSelect.appendChild(opt);
  }
})();

/* ------ 保存まわり（localStorage優先） ------ */
function saveAll(){
  const data = [];
  document.querySelectorAll('.col').forEach(col=>{
    const title = col.querySelector('.title').textContent;
    const items = Array.from(col.querySelectorAll('li .val')).map(v=>v.textContent);
    data.push({title, items});
  });
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(e){
    console.warn('保存に失敗しました', e);
  }
}
function loadAll(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const arr = JSON.parse(raw);
    arr.forEach(d=>{
      const col = createCol(d.title, d.items);
      elGrid.appendChild(col);
      registerColumn(col, d.title);
    });
  }catch(e){
    console.warn('読み込みに失敗しました', e);
  }
}

/* UIヘルパ */
function registerColumn(colEl, title){
  const id = colEl.dataset.colId;
  const opt = document.createElement('option');
  opt.value = id;
  opt.textContent = (title || 'ランキング') + `（ID:${id}）`;
  colSelect.appendChild(opt);
}
function removeColumnFromSelect(colId){
  const opt = colSelect.querySelector(`option[value="${colId}"]`);
  if(opt) opt.remove();
}
function findItem(colId, rankIndex1based){
  const col = document.querySelector(`.col[data-col-id="${colId}"]`);
  return col ? col.querySelector(`li[data-rank="${rankIndex1based}"]`) : null;
}

/* 1行フィット */
function fitTextToOneLine(valEl){
  const root = getComputedStyle(document.documentElement);
  const base = parseFloat(root.getPropertyValue('--baseFontPx')) || 16;
  const min  = parseFloat(root.getPropertyValue('--minFontPx'))  || 12;
  valEl.style.fontSize = base + 'px';
  valEl.style.whiteSpace = 'nowrap';
  valEl.style.overflow = 'hidden';
  valEl.style.textOverflow = 'ellipsis';
  if (valEl.scrollWidth <= valEl.clientWidth) return;
  let size = base;
  while (size > min) {
    size--;
    valEl.style.fontSize = size + 'px';
    if (valEl.scrollWidth <= valEl.clientWidth) return;
  }
  valEl.style.fontSize = min + 'px';
}

/* 項目（li） */
function createItem(rankIndex, text, colId){
  const rank1 = rankIndex + 1;
  const li = document.createElement('li');
  li.dataset.rank = String(rank1);
  li.dataset.colId = String(colId);

  const row = document.createElement('div'); row.className = 'rowin';
  const num = document.createElement('div'); num.className = 'num'; num.textContent = rank1 + '位';
  const val = document.createElement('div'); val.className = 'val'; val.textContent = text || '（未入力）';

  row.appendChild(num); row.appendChild(val);

  const mask = document.createElement('div'); mask.className = 'mask';
  const badgeWrap = document.createElement('div'); badgeWrap.className = 'rankBadge';
  badgeWrap.innerHTML = `<div class="badge">${rank1}位</div>`;

  li.addEventListener('click', () => {
    li.classList.toggle('revealed');
    if (li.classList.contains('revealed')) fitTextToOneLine(val);
  });

  li.appendChild(row); li.appendChild(mask); li.appendChild(badgeWrap);
  fitTextToOneLine(val);
  return li;
}

/* 列 */
function createCol(title, items10){
  const col = document.createElement('div'); col.className = 'col';
  const colId = ++colCounter; col.dataset.colId = String(colId);

  const titleRow = document.createElement('div'); titleRow.className = 'titleRow';
  const h = document.createElement('div'); h.className = 'title'; h.textContent = title || 'ランキング';
  const delBtn = document.createElement('button'); delBtn.textContent = '削除';
  delBtn.addEventListener('click', () => {
    col.remove(); removeColumnFromSelect(colId); saveAll();
    if(colSelect.value === String(colId)){ colSelect.value=''; rankSelect.value=''; editInput.value=''; }
  });
  titleRow.appendChild(h); titleRow.appendChild(delBtn); col.appendChild(titleRow);

  const list = document.createElement('ol');
  for (let i=0;i<10;i++) list.appendChild(createItem(i, items10[i] || '', colId));
  col.appendChild(list);

  return col;
}

/* 追加 */
document.getElementById('add').addEventListener('click', () => {
  const lines = elRank.value.split('\n').map(l => l.trim());
  const col = createCol(elTitle.value.trim(), lines);
  elGrid.appendChild(col);
  registerColumn(col, elTitle.value.trim());
  saveAll();
  elRank.value = ''; elTitle.value = '';
  colSelect.value = col.dataset.colId; rankSelect.value=''; editInput.value='';
});

/* 編集 */
function loadCurrentToEditor(){
  const colId = colSelect.value, r1 = rankSelect.value;
  if (!colId || !r1){ editInput.value = ''; return; }
  const li = findItem(colId, r1);
  editInput.value = li ? li.querySelector('.val').textContent : '';
}
colSelect.addEventListener('change', loadCurrentToEditor);
rankSelect.addEventListener('change', loadCurrentToEditor);

saveEdit.addEventListener('click', () => {
  const colId = colSelect.value, r1 = rankSelect.value;
  if (!colId || !r1) return;
  const li = findItem(colId, r1); if (!li) return;
  const valEl = li.querySelector('.val');
  valEl.textContent = (editInput.value || '').trim() || '（未入力）';
  fitTextToOneLine(valEl);
  saveAll();
});

/* 初期化：保存データ復元 */
loadAll();
</script>
</body>
</html>
